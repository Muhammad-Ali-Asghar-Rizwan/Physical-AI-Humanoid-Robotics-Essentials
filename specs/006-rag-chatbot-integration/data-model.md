# Data Model: RAG Chatbot Integration

## Overview

This document defines the data models for the RAG Chatbot Integration feature, including entity definitions, relationships, validation rules, and state transitions based on the feature requirements.

## Entity Definitions

### ChatSession
**Description**: Represents a conversation between user and chatbot

**Fields**:
- `id`: UUID (Primary Key) - Unique identifier for the session
- `user_id`: UUID (Optional) - Identifier for registered users
- `session_token`: String - Anonymous identifier for unregistered users
- `created_at`: DateTime - Time when session was created
- `updated_at`: DateTime - Time when session was last updated
- `is_active`: Boolean - Whether the session is currently active

**Relationships**:
- One-to-many with `QueryResponsePair` (via `session_id` foreign key)

**Validation Rules**:
- `created_at` must be in the past
- `updated_at` must be >= `created_at`
- Either `user_id` or `session_token` must be present

### QueryResponsePair
**Description**: A single user query and the corresponding AI-generated response with source citations

**Fields**:
- `id`: UUID (Primary Key) - Unique identifier for the pair
- `session_id`: UUID (Foreign Key) - References `ChatSession.id`
- `user_query`: Text - The original query from the user
- `ai_response`: Text - The response generated by the AI
- `source_citations`: JSON - List of source references used in the response
- `query_metadata`: JSON - Context information (selected text, page, etc.)
- `timestamp`: DateTime - When the query was made
- `feedback_score`: Integer (Optional) - User feedback rating (1-5)
- `feedback_comment`: Text (Optional) - User feedback comment

**Relationships**:
- Many-to-one with `ChatSession` (via `session_id` foreign key)
- Many-to-many with `TextChunk` (via `retrieved_chunks` relationship)

**Validation Rules**:
- `session_id` must reference an existing `ChatSession`
- `user_query` must not be empty
- `timestamp` must be in the past
- `feedback_score` must be between 1-5 if present
- `source_citations` must be a valid JSON array

### TextChunk
**Description**: Segments of the textbook content (500-1000 tokens) with associated metadata

**Fields**:
- `id`: UUID (Primary Key) - Unique identifier for the chunk
- `content`: Text - The actual text content (500-1000 tokens)
- `chunk_order`: Integer - Order of this chunk within the document
- `document_id`: String - Identifier for the source document
- `document_title`: String - Title of the source document
- `chapter`: String - Chapter name/number
- `section`: String - Section name/number
- `page_reference`: String (Optional) - Page number reference
- `filename`: String - Source filename
- `token_count`: Integer - Number of tokens in the chunk
- `embedding_id`: String - ID of the corresponding embedding in Qdrant
- `created_at`: DateTime - When the chunk was created

**Relationships**:
- Many-to-many with `QueryResponsePair` (via `retrieved_chunks` relationship)

**Validation Rules**:
- `content` must be between 500-1000 tokens
- `chunk_order` must be >= 0
- `token_count` must match actual tokenized content
- `embedding_id` must be valid Qdrant ID format

### EmbeddingVector
**Description**: Numerical representation of a text chunk for similarity search in the vector database

**Fields**:
- `id`: String (Primary Key) - ID of the embedding in Qdrant
- `text_chunk_id`: UUID (Foreign Key) - References `TextChunk.id`
- `vector`: Array of Floats - The actual embedding vector
- `model_used`: String - Embedding model that generated this vector
- `created_at`: DateTime - When the embedding was created
- `is_active`: Boolean - Whether this embedding is active for search

**Relationships**:
- One-to-one with `TextChunk` (via `text_chunk_id` foreign key)

**Validation Rules**:
- `vector` must have the correct dimensions for the model used
- `model_used` must be a supported embedding model
- `text_chunk_id` must reference an existing `TextChunk`

### SourceReference
**Description**: Information about the origin of content used in a response

**Fields**:
- `id`: UUID (Primary Key) - Unique identifier for the reference
- `query_response_pair_id`: UUID (Foreign Key) - References `QueryResponsePair.id`
- `text_chunk_id`: UUID (Foreign Key) - References `TextChunk.id`
- `document_title`: String - Title of the referenced document
- `chapter`: String - Chapter name/number
- `section`: String - Section name/number
- `page_reference`: String (Optional) - Page number reference
- `excerpt`: Text - Excerpt from the referenced content
- `similarity_score`: Float - Similarity score of this reference to the query

**Relationships**:
- Many-to-one with `QueryResponsePair` (via `query_response_pair_id` foreign key)
- Many-to-one with `TextChunk` (via `text_chunk_id` foreign key)

**Validation Rules**:
- `query_response_pair_id` must reference an existing `QueryResponsePair`
- `text_chunk_id` must reference an existing `TextChunk`
- `similarity_score` must be between 0 and 1
- `excerpt` must be part of the content in the associated `TextChunk`

### User
**Description**: Information about registered users (optional for personalization)

**Fields**:
- `id`: UUID (Primary Key) - Unique identifier for the user
- `email`: String (Optional) - User's email address
- `name`: String (Optional) - User's display name
- `created_at`: DateTime - When the user account was created
- `updated_at`: DateTime - When the user account was last updated
- `preferences`: JSON (Optional) - User preferences (e.g., notification settings)

**Relationships**:
- One-to-many with `ChatSession` (via `user_id` foreign key)

**Validation Rules**:
- `email` must be a valid email address if provided
- `created_at` must be in the past
- `updated_at` must be >= `created_at`

## Relationships Summary

- `User` (1) : (0..n) `ChatSession` - A user can have multiple chat sessions
- `ChatSession` (1) : (0..n) `QueryResponsePair` - A session contains multiple query-response pairs
- `QueryResponsePair` (0..n) : (0..n) `TextChunk` - A response can reference multiple text chunks
- `TextChunk` (1) : (0..1) `EmbeddingVector` - A text chunk has one corresponding embedding
- `QueryResponsePair` (1) : (0..n) `SourceReference` - A response can have multiple source references
- `TextChunk` (1) : (0..n) `SourceReference` - A text chunk can be referenced in multiple responses

## Validation Rules Summary

1. **Chat Session Validation**:
   - Session must have either user ID or anonymous token
   - Session timestamps are logically ordered
   - Active sessions are properly tracked

2. **Query Response Validation**:
   - Query must be present and non-empty
   - Response is linked to a valid session
   - Feedback scores are within valid range
   - Source citations are properly formatted

3. **Text Chunk Validation**:
   - Content size is within token limits (500-1000 tokens)
   - All required metadata is present
   - Corresponding embedding exists in Qdrant

4. **Embedding Validation**:
   - Vector dimensions match expected model
   - Associated text chunk exists
   - Embedding ID is properly formatted

5. **Source Reference Validation**:
   - References valid query-response pairs and text chunks
   - Similarity scores are within 0-1 range
   - Excerpts match the source content

## State Transitions

### ChatSession State Transitions
- `created` → `active` → `inactive` → `archived`
- New session starts as active
- Session becomes inactive after period of inactivity
- Old sessions are archived to optimize database performance

### QueryResponsePair State Transitions
- `created` → `processing` → `complete` → `evaluated`
- Query is received and stored
- AI processes the query
- Response is generated and stored
- User feedback is optionally collected